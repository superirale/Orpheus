name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux x64
            os: ubuntu-latest
            artifact: orpheus-linux-x64
            lib_ext: .a
          - name: macOS x64
            os: macos-latest
            artifact: orpheus-macos-x64
            lib_ext: .a
          - name: Windows x64
            os: windows-latest
            artifact: orpheus-windows-x64
            lib_ext: .lib
          - name: Android arm64
            os: ubuntu-latest
            artifact: orpheus-android-arm64
            lib_ext: .a
            android: true
            abi: arm64-v8a

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux' && !matrix.android
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libpulse-dev

      - name: Setup Android NDK
        if: matrix.android
        uses: android-actions/setup-android@v3
        with:
          packages: 'ndk;27.0.11718014'

      - name: Configure CMake
        if: "!matrix.android"
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Configure CMake (Android)
        if: matrix.android
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DORPHEUS_BUILD_TESTS=OFF \
            -DORPHEUS_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package (Linux)
        if: runner.os == 'Linux' && !matrix.android
        run: |
          mkdir -p dist/include dist/lib
          cp -r include/* dist/include/
          # Merge SoLoud into Orpheus for a single fat static library (GNU ar)
          echo "CREATE dist/lib/liborpheus.a" > merge.mri
          echo "ADDLIB build/liborpheus.a" >> merge.mri
          echo "ADDLIB build/libsoloud_fetched.a" >> merge.mri
          echo "SAVE" >> merge.mri
          echo "END" >> merge.mri
          ar -M < merge.mri
          cp README.md dist/
          cp CHANGELOG.md dist/
          cp LICENSE dist/ 2>/dev/null || echo "MIT" > dist/LICENSE
          cd dist && zip -r ../${{ matrix.artifact }}.zip .

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p dist/include dist/lib
          cp -r include/* dist/include/
          # Merge SoLoud into Orpheus using libtool (BSD)
          libtool -static -o dist/lib/liborpheus.a build/liborpheus.a build/libsoloud_fetched.a
          cp README.md dist/
          cp CHANGELOG.md dist/
          cp LICENSE dist/ 2>/dev/null || echo "MIT" > dist/LICENSE
          cd dist && zip -r ../${{ matrix.artifact }}.zip .

      - name: Package (Android)
        if: matrix.android
        run: |
          mkdir -p dist/include dist/lib/${{ matrix.abi }}
          cp -r include/* dist/include/
          # Merge SoLoud into Orpheus for a single fat static library
          echo "CREATE dist/lib/${{ matrix.abi }}/liborpheus.a" > merge.mri
          echo "ADDLIB build/liborpheus.a" >> merge.mri
          echo "ADDLIB build/libsoloud_fetched.a" >> merge.mri
          echo "SAVE" >> merge.mri
          echo "END" >> merge.mri
          ar -M < merge.mri
          cp README.md dist/
          cp CHANGELOG.md dist/
          cp LICENSE dist/ 2>/dev/null || echo "MIT" > dist/LICENSE
          cd dist && zip -r ../${{ matrix.artifact }}.zip .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          mkdir dist\include dist\lib
          xcopy /E /I include dist\include
          REM Merge SoLoud into Orpheus using lib.exe from VS
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          lib /OUT:dist\lib\orpheus.lib build\Release\orpheus.lib build\Release\soloud_fetched.lib
          copy README.md dist\
          copy CHANGELOG.md dist\
          if exist LICENSE (copy LICENSE dist\) else (echo MIT > dist\LICENSE)
          powershell Compress-Archive -Path dist\* -DestinationPath ${{ matrix.artifact }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.zip

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -la artifacts/*/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG.md
          files: |
            artifacts/orpheus-linux-x64/*.zip
            artifacts/orpheus-macos-x64/*.zip
            artifacts/orpheus-windows-x64/*.zip
            artifacts/orpheus-android-arm64/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
